version: '3.8'

services:
    # Neon Local Database Proxy
    neon-local:
        image: neondatabase/neon_local:latest
        container_name: acquisition-neon-local
        ports:
            - '5432:5432'
        env_file:
            - .env.development
        volumes:
            # Optional: Persist branches per Git branch
            - ./.neon_local/:/tmp/.neon_local
            - ./.git/HEAD:/tmp/.git/HEAD:ro,consistent
        networks:
            - acquisition-network
        healthcheck:
            test:
                [
                    'CMD',
                    'pg_isready',
                    '-h',
                    'localhost',
                    '-p',
                    '5432',
                    '-U',
                    'neon',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # Application Service
    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: acquisition-app-dev
        ports:
            - '4000:4000'
        env_file:
            - .env.development
        volumes:
            # Mount source code for hot reload
            - ./src:/app/src
            - ./package.json:/app/package.json:ro
            # Exclude node_modules to prevent conflicts
            - /app/node_modules
        networks:
            - acquisition-network
        depends_on:
            neon-local:
                condition: service_healthy
        restart: unless-stopped
        stdin_open: true
        tty: true
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "const http = require('http'); const req = http.request({hostname: 'localhost', port: 4000, path: '/health'}, (res) => process.exit(res.statusCode === 200 ? 0 : 1)); req.on('error', () => process.exit(1)); req.end();",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

networks:
    acquisition-network:
        driver: bridge

volumes:
    neon-local-data:
        driver: local
